name: Importar repositorios

on:
  workflow_dispatch:
    inputs:
      URL:
        description: 'URL del repositorio a importar'
        required: true
        default: ''
permissions:
  contents: write

jobs:
  importarRepos:
      runs-on: windows-latest
      steps:
        - name: Checkout
          uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
          with:
            token: ${{ github.token }}

        - name: Configurar identidad de Git
          run: |
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        - name: Importar repositorio
          shell: pwsh
          continue-on-error: true
          run: |
            $url = "https://${{github.actor}}:${{secrets.GitLabToken}}@gitlab.com/${{github.event.inputs.URL}}"
            git remote add oldRepo $url
            git fetch oldRepo
            git merge oldRepo/main --allow-unrelated-histories 
            if ($LASTEXITCODE -ne 0){
              Write-Host "Merge conflict detected, resolving automatically"
            }
        
        - name: resolver conflictos en Readme
          run: |
            $file = "README.md"
            git show HEAD:$file > ours.tmp
            git show oldRepo/main:$file > theirs.tmp

            Get-Content ours.tmp, theirs.tmp | Set-Content $file
            git add $file

        - name: resolver conflictos en .gitignore
          run: |
            $file = ".gitignore"
            git show HEAD:$file > ours.tmp
            git show oldRepo/main:$file > theirs.tmp

            Get-Content ours.tmp, theirs.tmp | Set-Content $file
            git add $file
        
        - name: Eliminar temporales y rama remote
          run: |
            Remove-Item ours.tmp, theirs.tmp -ErrorAction SilentlyContinue
            git remote remove oldRepo

        - name: Commit y push a main
          run: | 
            git add .
            git commit -m "Importar repositorio desde ${{github.event.inputs.URL}}"
            git push origin main